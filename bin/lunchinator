#!/bin/bash

LUNCH_DIR=$HOME/.lunchinator-dist-sap
LUNCH_GIT=drgit@luder.dhcp.wdf.sap.corp:/lunchinator.git
LUNCH_PLUGINS_DIR=$HOME/.lunchinator/plugins
LUNCH_PLUGINS_GIT=drgit@luder.dhcp.wdf.sap.corp:/lunchinator_plugins.git

if test "$1" = "--reinstall"
then
  if test -f "${LUNCH_DIR}/bin/send_call.py"
  then
    echo "Stopping Lunchinator for reinstall"
    "${LUNCH_DIR}/bin/send_call.py" "HELO_STOP reinstall" 127.0.0.1
    echo "Waiting for a second"
    sleep 1
  fi

  echo "removing old versions"
  rm -rf "$LUNCH_DIR"
  rm -rf "$LUNCH_PLUGINS_DIR"
fi

if ! test -f "${LUNCH_DIR}/README"
then
  echo "-- Installing main program --"
  git clone $LUNCH_GIT "$LUNCH_DIR"
fi

if ! test -f "${LUNCH_PLUGINS_DIR}/README"
then
  echo "-- Installing extra plugins --"
  mkdir -p "$LUNCH_PLUGINS_DIR"
  git clone $LUNCH_PLUGINS_GIT "$LUNCH_PLUGINS_DIR"
fi

"${LUNCH_DIR}/start_lunchinator.py" --updateCode
UPDATE_CODE=$?

"${LUNCH_DIR}/start_lunchinator.py" --should-auto-update
UPDATE=$?

RESTART=1
while [ "$RESTART" -eq 1 ]
do
	if [ "$UPDATE" -eq 1 ]
	then
		"${LUNCH_DIR}/start_lunchinator.py" --update
		find "$LUNCH_DIR" -name "*.pyc" -delete
		find "$LUNCH_PLUGINS_DIR" -name "*.pyc" -delete
	fi
	
	RESTART=0
	UPDATE=0
	
	"${LUNCH_DIR}/start_lunchinator.py"
	EXIT_CODE=$?
	if [ "$EXIT_CODE" -eq "$UPDATE_CODE" ]
	then
		RESTART=1
		UPDATE=1
	fi
done

